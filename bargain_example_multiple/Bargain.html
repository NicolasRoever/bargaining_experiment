{{ block title }}
Price Negotiation
{{ endblock }}
{{ block content }}
<style>
    .mgslider-wrapper {
        border-spacing: 10px;
    }

    .mgslider-limit {
        width: 10%;
        min-width: 75px;
        height: 40px;
        margin: 100px;
        text-align: center;
        background: #eee;
        border: 1px solid #888;
    }

    .mgslider-limit, .mgslider-value {
        font-variant-numeric: tabular-nums;
    }

    .mgslider-before {
        height: 16px;
        width: 100%;
        background: #1e5bff;
    }

    .mgslider-feedback {
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .slider-container {
        display: flex;
        align-items: center;
    }

    .mgslider-wrapper {
        width: 95%;
        height: 50%; /* Adjust height as needed */
    }

    #submit {
        position: absolute; /* Position button absolutely */
        top: 16.6%; /* Adjust bottom spacing as needed */
        left: 75%; /* Position horizontally centered */
        transform: translateX(-50%); /* Center horizontally */
    }

    button#submit {
        background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin-left: 10px;
        border-radius: 5px;
        cursor: pointer;
    }

    button#submit:hover {
        background-color: #45a049; /* Darker Green */
    }

    .otree-timer {
    display: none;
    }

</style>



<p>
    You are the {{ player.role }}.
    Please negotiate with the {{ other_role }} below.
</p>

<p style="border: 2px solid black; padding: 10px">In this match, your value of the object is {{ valuation }}. </p>


    


    <div class="middle" style="background-color: #f2f2f2; padding: 15px">
        <b><p style="display: inline;"> Time: <div style="display: inline;" id="time_spent"></div> seconds </p></b>

        <h4>Please place your price offer:</h4>
                <div id="my-proposal">(none)</div>
                
                <div id="my_slider"></div>

                    <button type="button" id="btn-offer-slider" onclick="sendOffer()">Submit Proposal</button>

            
        <h4 style="margin-top: 2cm;">{{ other_role }}'s price offer:</h4>
                <div id="other-proposal">(none)</div>

                <div id="slider_other"></div>
    </div>

<div style="display: flex; justify-content: space-between; margin-top: 1cm;">
    <div style="flex: 1; margin-right: 20px; padding: 15px;">
        <canvas id="TA_cost_chart" style="width: 100%; min-height: 200px;"></canvas>

        <div style="margin-top: 1cm; background-color: #A2D5F2; padding: 15px">
            <h5>Transaction Costs</h5>
        
            <p style="display:inline">Current transaction costs per 10 seconds: <div style="display: inline" id ="TA_costs"></div>.</p>
        
            <p style="display:inline">Cumulated total transaction costs: <div style="display: inline" id ="cumulated_TA_costs"></div>.</p>
        
        </div>
    </div>

    <div style=" flex: 1; margin-left: 20px; padding: 15px;">
        <canvas id="delay_chart" style="width: 100%; min-height: 200px;" ></canvas>

        <div style="margin-top: 1cm; background-color: #A2D5F2; padding: 15px">
    <h5>Delay in Payment</h5>

    <p style="display:block">Delay in payment per 10 seconds: 1 day.</p>

    <p style="display:inline">Cumulated delay in payment: <div style="display: inline" id ="payment_delay"></div> day(s).</p>

</div>
    </div>
</div>



<div style="display: flex; justify-content: space-between; margin-top: 1cm;">
    <div style="flex: 0.9; background-color: #f2f2f2; padding: 15px; margin-right: 20px">
        <button type="button" id="btn-terminate" style="display: block;" onclick="sendTerminate()">Terminate</button>
        <p style="margin-top:3cm;display: inline;">Your payoff: <div style="display: inline" id="my_payoff_terminate" ></div></p>
        <p>{{ other_role }}'s payoff: ???</p>
    </div>

    <div style="flex: 0.9; background-color: #f2f2f2; padding: 15px; margin-left: 20px;">
        <button type="button" id="btn-accept" onclick="sendAccept(this)" style="display: block;" disabled>Accept {{other_role}}'s offer</button>
        <p id="my_payoff_accept_text" style="display: inline">Your payoff: <div style="display: inline" id ="my_payoff_accept">(none)</div></p>
        <p>{{ other_role }}'s payoff: ???</p>
    </div>  
</div>


<script src="{{ static 'mgslider.js' }}"></script>

<script
src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
</script>


<script>

    var array_time_passed = []
    var array_cumulated_costs = []
    var array_delay = []

    //var seconds = 0;
    //function startTimer() {
    //    setInterval(function() {
    //        seconds++;
    //        document.getElementById('timeSpent').innerText = "You've spent " + seconds;
    //    }, 1000);
    //}
    //window.onload = startTimer

    $(document).ready(function (event) {
                    my_slider = new mgslider("offer", 0, 10, 0.1);
                    my_slider.print(document.getElementById("my_slider"));
                    //my_slider.addSubmitter(function() {liveSend({'type':'propose', 'amount':my_slider.getValue()})} )
                    //my_slider.recall(); // Optional line to remember value across errors
                    slider_other = new mgslider("other_offer", 0, 10, 0.1);
                    slider_other.yourvalue = js_vars.other_role + "'s " + " Proposal";
                    slider_other.print(document.getElementById("slider_other"));
                    //slider_other.recall(); // Optional line to remember value across errors
                });
   
    let btnOffer = document.getElementById('btn-offer');
    let btnSliderSubmit = document.getElementById('btn-offer-slider');
    let my_offer = document.getElementById('my_offer');
    
    let msgOtherProposal = document.getElementById('other-proposal');
    let msgMyProposal = document.getElementById('my-proposal');
    
    let btnAccept = document.getElementById('btn-accept');
    let msgMyPayoffAccept = document.getElementById('my_payoff_accept')

    let otherProposal;

    //my_offer.addEventListener("keydown", function (event) {
    //    if (event.key === "Enter") {
    //        sendOffer();
    //    }
    //});

    function sendOffer() {
        liveSend({'type': 'propose', 'amount': my_slider.value(), 'offer_time': Math.floor(Date.now()/1000 - js_vars.start_time),'latest_proposal_by': js_vars.my_id})
        my_offer.value = '';
    }

    function sendAccept() {
        liveSend({'type': 'accept', 'amount': otherProposal, 'acceptance_time': Math.floor(Date.now()/1000 - js_vars.start_time), 'accepted_by': js_vars.my_id})
    }

    function sendTerminate() {
        liveSend({'type': 'terminate', 'termination_time': Math.floor(Date.now()/1000 - js_vars.start_time), 'terminated_by': js_vars.my_id})
    }

    let USDollar = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    });

    function liveRecv(data) {

        if ('bargaining_time_elapsed' in data) {
            document.getElementById('time_spent').innerHTML = data.bargaining_time_elapsed;

            array_time_passed.push(data.bargaining_time_elapsed);
            array_time_passed = Array.from(new Set(array_time_passed))
            //console.log(array_time_passed)
            array_cumulated_costs.push(data.cumulated_TA_costs)
            array_cumulated_costs = Array.from(new Set(array_cumulated_costs))
            //console.log(array_cumulated_costs)
            console.log(data.cumulated_TA_costs)

            array_delay.push(data.payment_delay)
            array_delay = Array.from(new Set(array_delay))
        }

        if ('current_TA_costs' in data) {
            document.getElementById('TA_costs').innerHTML = USDollar.format(data.current_TA_costs/100)
        }

        if ('cumulated_TA_costs' in data) {
            document.getElementById('cumulated_TA_costs').innerHTML = USDollar.format(data.cumulated_TA_costs/100);

            document.getElementById('my_payoff_terminate').innerHTML = USDollar.format(data.current_payoff_terminate/100)

            document.getElementById('payment_delay').innerHTML = data.payment_delay
        }

        if ('current_proposals' in data) {

            for (let [id_in_group, proposal] of data.current_proposals) {

                if (id_in_group === js_vars.my_id) {
                    msgMyProposal.innerHTML = USDollar.format(proposal/100);
            
                } else if (id_in_group === js_vars.other_id) {
                    msgOtherProposal.innerHTML = USDollar.format(proposal/100);
                    otherProposal = proposal;
                    btnAccept.disabled = false;
                    slider_other.set(proposal/100);
                    document.getElementById(slider_other.id("cur")).innerHTML = slider_other.f2s(proposal/100, false);
                }
                
            }
            
            if (data['latest_proposal_by'] === js_vars.my_id) {
                btnSliderSubmit.disabled = true;
                my_slider.submit();
                my_slider.disable();
                slider_other.disable();
            } else if (data['latest_proposal_by'] === js_vars.other_id) {
                btnSliderSubmit.disabled = false;
                my_slider.enable();
                slider_other.disable();
                //slider_other.set(5)
            }
            //print(data['current_deal_accept'])
        }

        if ('current_payoffs_accept' in data) {

            for (let [id_in_group, current_deal_accept] of data.current_payoffs_accept){

                if (id_in_group === js_vars.my_id){
                    document.getElementById('my_payoff_accept_text').style.display = 'inline';
                    msgMyPayoffAccept.innerHTML = USDollar.format(current_deal_accept/100)
                }
            }

        }

        if ('finished' in data) {
            document.getElementById('form').submit();
        }
    
    const xValues = Array.from({length: 10}, (_, i) => i * 10); //array_time_passed; //[0, 10, 20, 30] //
    const yValues_cost = array_cumulated_costs;

    new Chart("TA_cost_chart", {
    type: "line",
    data: {
        labels: xValues,
        datasets: [{
        fill: false,
        lineTension: 0,
        backgroundColor: "rgba(0,0,255,1.0)",
        borderColor: "rgba(0,0,255,0.1)",
        data: yValues_cost, 
        step: true
        }]
    },
    options: {
        //responsive: true, 
        animation: {
            duration: 0
        },
        legend: {display: false},
        scales: {
            yAxes: [{
            ticks: {min: 0, max:500},
            scaleLabel: {
                display: true, 
                labelString: "Total Costs",
            },
            }],
            xAxes: [{
            //ticks: {min: 0, max:50},
            scaleLabel: {
                display: true, 
                labelString: "Seconds passed",
            },
            }]
        },
    }
    });

    const yValues_delay = array_delay

    new Chart("delay_chart", {
    type: "line",
    data: {
        labels: xValues,
        datasets: [{
        fill: false,
        lineTension: 0,
        backgroundColor: "rgba(0,0,255,1.0)",
        borderColor: "rgba(0,0,255,0.1)",
        data: yValues_delay, 
        step: true
        }]
    },
    options: {
        //responsive: true, 
        animation: {
            duration: 0
        },
        legend: {display: false},
        scales: {
            yAxes: [{
            ticks: {min: 0, max:50},
            scaleLabel: {
                display: true, 
                labelString: "Total Delay",
            },
            }],
            xAxes: [{
            //ticks: {min: 0, max:50},
            scaleLabel: {
                display: true, 
                labelString: "Seconds passed",
            },
            }]
        },
    }
    });
    
    }


    // Update live page every second
    setInterval(
        function () {
            //let seconds_left = Math.max(0, js_vars.deadline - Date.now() / 1000);
            //let frac = seconds_left / js_vars.TIMEOUT_SECONDS;
            //for (let d of js_vars.RANKS) {
            //document.getElementById('time_test').innerHTML = seconds_left; //Math.round(frac);
            //console.log('time left:', seconds_left);
            //}
            liveSend({})
        },
        1000
    )

    document.addEventListener('DOMContentLoaded', (event) => {
        liveSend({});
    });

    //document.addEventListener("DOMContentLoaded", function (event) {
     //   $('.otree-timer__time-left').on('update.countdown', function (event) {
            //if (event.offset.totalSeconds === 10) {
            //    $('.otree-timer').show();
            //}
     //       liveSend({'time_left': event.offset.totalSeconds})
            //console.log('time left:', event.offset.totalSeconds)
    //    });
    //});
    

</script>

{{ endblock }}