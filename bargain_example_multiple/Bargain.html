{{ block title }}
Make a deal
{{ endblock }}
{{ block content }}


<p>
    You are the {{ player.role }}.
    Please negotiate with the {{ other_role }} below.
</p>

<p>Your valuation for the object is {{ valuation }}. </p>

<p style="display:inline">Your current transaction costs per 10 seconds for the negotiation are <div style="display: inline" id ="TA_costs"></div>.</p>

<p style="display:inline">And your cumulated total transaction costs for the negotiation are <div style="display: inline" id ="cumulated_TA_costs"></div>.</p>


<table class="table">
    <tr>
        <th>Your current proposal</th>
        <td id="my-proposal">(none)</td>
        <td>
            <input type="number" id="my_offer">
            <button type="button" onclick="sendOffer()" id="btn-offer">Make new offer</button>
        </td>
    </tr>
    <tr>
        <th>{{ other_role }} proposal</th>
        <td id="other-proposal">(none)</td>
    </tr>
</table>


<p id="my_payoff_accept_text" style="display: none">If you accept the current proposal by the {{ other_role }}, your payoff will be <div style="display: inline" id ="my_payoff_accept"></div></p>
<button type="button" id="btn-accept" onclick="sendAccept(this)" style="display: none">Accept {{other_role}}'s offer</button>




<p style="margin-top:3cm;display: inline;">If you terminate the negotiation, there will be no deal and your payoff will be <div style="display: inline" id="my_payoff_terminate" ></div></p>
<button type="button" id="btn-terminate" onclick="sendTerminate()">Terminate</button>

<script>
   
    let btnOffer = document.getElementById('btn-offer');
    let my_offer = document.getElementById('my_offer');
    
    let msgOtherProposal = document.getElementById('other-proposal');
    let msgMyProposal = document.getElementById('my-proposal');
    
    let btnAccept = document.getElementById('btn-accept');
    let msgMyPayoffAccept = document.getElementById('my_payoff_accept')

    let otherProposal;

    //my_offer.addEventListener("keydown", function (event) {
    //    if (event.key === "Enter") {
    //        sendOffer();
    //    }
    //});

    function sendOffer() {
        liveSend({'type': 'propose', 'amount': my_offer.value, 'latest_proposal_by': js_vars.my_id})
        my_offer.value = '';
    }

    function sendAccept() {
        liveSend({'type': 'accept', 'amount': otherProposal, 'accepted_by': js_vars.my_id})
    }

    function sendTerminate() {
        liveSend({'type': 'terminate', 'terminated_by': js_vars.my_id})
    }

    let USDollar = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    });

    function liveRecv(data) {
        if ('current_TA_costs' in data) {
            document.getElementById('TA_costs').innerHTML = USDollar.format(data.current_TA_costs/100)
        }

        if ('cumulated_TA_costs' in data) {
            document.getElementById('cumulated_TA_costs').innerHTML = USDollar.format(data.cumulated_TA_costs/100);
            document.getElementById('my_payoff_terminate').innerHTML = USDollar.format(data.current_payoff_terminate/100)
        }

        if ('current_proposals' in data) {

            for (let [id_in_group, proposal] of data.current_proposals) {

                if (id_in_group === js_vars.my_id) {
                    msgMyProposal.innerHTML = USDollar.format(proposal/100);
            
                } else {
                    msgOtherProposal.innerHTML = USDollar.format(proposal/100);
                    otherProposal = proposal;
                    btnAccept.style.display = 'block';
                    
                }
                
            }
            
            if (data['latest_proposal_by'] === js_vars.my_id) {
                btnOffer.disabled = true;
            } else {
                btnOffer.disabled = false;
            }
            //print(data['current_deal_accept'])
        }

        if ('current_payoffs_accept' in data) {

            for (let [id_in_group, current_deal_accept] of data.current_payoffs_accept){

                if (id_in_group === js_vars.my_id){
                    document.getElementById('my_payoff_accept_text').style.display = 'inline';
                    msgMyPayoffAccept.innerHTML = USDollar.format(current_deal_accept/100)
                }
            }

        }

        if ('finished' in data) {
            document.getElementById('form').submit();
        }
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        liveSend({});
    });

    document.addEventListener("DOMContentLoaded", function (event) {
        $('.otree-timer__time-left').on('update.countdown', function (event) {
            //if (event.offset.totalSeconds === 10) {
            //    $('.otree-timer').show();
            //}
            liveSend({'time_left': event.offset.totalSeconds})
            //console.log('time left:', event.offset.totalSeconds)
        });
    });
    

</script>

{{ endblock }}