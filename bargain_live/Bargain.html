{{ block title }}
Price Negotiation
{{ endblock }}
{{ block content }}
<style>
    .mgslider-wrapper {
        border-spacing: 10px;
    }

    .mgslider-limit {
        width: 10%;
        min-width: 75px;
        height: 40px;
        margin: 100px;
        text-align: center;
        background: #eee;
        border: 1px solid #888;
    }

    .mgslider-limit, .mgslider-value {
        font-variant-numeric: tabular-nums;
    }

    .mgslider-before {
        height: 16px;
        width: 100%;
        background: #1e5bff;
    }

    .mgslider-feedback {
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .slider-container {
        display: block;
        align-items: center;
        margin-bottom: 0.5cm;
    }

    .mgslider-wrapper {
        width: 100%;
        height: 50%; /* Adjust height as needed */
    }

    #submit {
        position: absolute; /* Position button absolutely */
        top: 16.6%; /* Adjust bottom spacing as needed */
        left: 75%; /* Position horizontally centered */
        transform: translateX(-50%); /* Center horizontally */
    }

    .button {
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: block;
        font-size: 16px;
        border-radius: 5px;
        cursor: auto;
    }

    .button.offer {
        background-color: #4CAF50; /* Green */
        
    }

    .button.offer:hover {
        background-color: #45a049; /* Darker Green */
    }

    .button.accept {
        background-color: #2955cc; /* Blue */
        
    }

    .button.accept:disabled {
        background-color: #525452; /* Dark Grey */
    }

    .button.accept:disabled:hover {
        background-color: #525452; /* Dark Grey */
    }

    .button.accept:hover {
        background-color: #1e3e98; /* Darker Blue */
    }

    .button.terminate {
        background-color: #c71616; /* Red */
    }

    .button.terminate:hover {
        background-color: #9b0f0f; /* Darker Red */
    }

 

    .otree-timer {
    display: none;
    }


    .two_columns_left {
        flex: 1;  
        margin-right: 0.5cm;
        padding: 15px;
    }

    .two_columns_right {
        flex: 1;  
        margin-left: 0.5cm;
        padding: 15px;
    }

    body {
    display: flex;
    justify-content: center;
    overflow: auto;
    align-items: center;
    flex-direction: column;
    width: 1200px;
    }

    .central_container {
        
        justify-content: center;
        width: 150%;
        position: relative;
    }

    .three_columns_container {
    display: flex;
    justify-content: space-between;
    width: 100%;
    gap: 20px;
    
    }


    .two_columns_container {
        display: flex; 
        justify-content: space-between; 
        margin-top: 1cm; 
        width: 100%;
    }

    .three_columns_left, .three_columns_right {
        background-color: #dfedf5;
        padding: 20px;
    }

    
    
    .chat {
        width: 150%;
    }

</style>


<div class="central_container">

<p>
    You are the {{ player.role }}.
    Please negotiate with the {{ other_role }} below.
</p>

<div class="three_columns_container">
<p style="background-color: #f2f2f2; padding: 15px; width: 150%;">  
   
    In this match, your value of the object is <b>{{ valuation }}</b><br/><br/>
    The {{ other_role }}'s value of the object is 
    {% if information_asymmetry == "None" or information_asymmetry != other_role %}
        <b>unknown to you</b>.
    {% else %}
        <b>{{ other_valuation }}</b>.
    {% endif %}
</p>

</div>
    

<div class="three_columns_container">
    <div class="three_columns_left" style="flex: 0.5;">
        <h5>Transaction Costs</h5>
        
            <p style="display:inline">Current transaction costs per second: <div style="display: inline" id ="TA_costs"></div>.</p>
        
            <p style="display:inline"> Total transaction costs: <div style="display: inline" id ="cumulated_TA_costs"></div>.</p>
        
            <canvas id="TA_cost_chart" style="width: 100%; min-height: 200px;"></canvas>
    </div>

    <div class="three_columns_middle" style="flex: 1;">
    
    <div style="background-color: #f2f2f2; padding: 15px">
        <b><p style="display: inline;"> Time: <div style="display: inline;" id="time_spent"></div> seconds </p></b>

        <h4 style="display:inline">Your current submitted price offer:</h4>
                <div id="my-proposal" style="display: inline; margin-left: 0.5cm;"> No offer yet.</div>
            
            <div class="slider-container">
                <div class="mgslider-wrapper" id="my_slider" style="margin-top: 1cm;"></div>

                <button type="button" class="button offer" id="btn-offer-slider" onclick="sendOffer()">Submit</button>
            </div>
        
        <h5>If the {{ other_role }} accepts your current offer: </h5>

            <p style="margin-top:3cm;display: inline;">Your payoff: <div style="display: inline" id="my_payoff_other_accepts_live"> No offer yet. </div></p>
            <p style="margin-top:3cm;display: inline;">{{ other_role }}'s payoff: 
                {% if information_asymmetry == "None" or information_asymmetry != other_role %}

                    ???

                {% else %}
                    <div style="display: inline" id="other_payoff_other_accepts_live"> 
                        No offer yet. 
                    </div>
                
                {% endif %}
            </p>

            
    </div>

    <div style="background-color: #f2f2f2; padding: 15px; margin-top: 1cm;">
            
        <h4 style="display:inline" style="margin-top: 0.5cm;">{{ other_role }}'s current submitted price offer:</h4>
                <div style="display:inline; margin-left: 0.5cm; margin-top: 0.5cm;" id="other-proposal"> No offer yet. </div>

                <div class="slider-container">
                    <div class="mgslider-wrapper" id="slider_other" style="margin-top: 1cm;"></div>
                
                    <button type="button" class="button accept" id="btn-accept" onclick="sendAccept(this)" style="display: block; margin-bottom: 1cm;" disabled>Accept {{other_role}}'s offer</button>
                </div>

                <h5>If you accept the {{ other_role }}'s offer: </h5>

                    <p id="my_payoff_accept_text" style="display: inline; ">Your payoff: <div style="display: inline" id ="my_payoff_accept">No offer yet.</div></p>
                    <p style="display: inline;">{{ other_role }}'s payoff: 
                        {% if information_asymmetry == "None" or information_asymmetry != other_role %}
            
                                ???
            
                            {% else %}
                                <div style="display: inline" id="other_payoff_accept"> 
                                    No offer yet. 
                                </div>
                            
                            {% endif %}
                    </p>

    </div>
    </div>

    <div class="three_columns_right" style="flex: 0.5;">
        <h5>Delay in Payment</h5>

            <p style="display:block">Delay in payment per second: {{ additional_delay }} 
                
                {% if additional_delay == 1 %}
                day.</p>

                {% else %}
                days.</p>

                {% endif %}

            <p style="display:inline">Total delay in payment: <div style="display: inline" id ="payment_delay"></div> day(s).</p>
0
            <canvas id="delay_chart" style="width: 100%; min-height: 200px;" ></canvas>
    </div>
</div>

<div class="three_columns_container" style="padding: 15px; ">
    <div class="three_columns_left" style="background-color: #ffffff; flex: 0.5">

    </div>
    <div class="three_columns_middle" style="padding: 15px; background-color: #f2f2f2; flex: 1; margin-top: 1cm;">

        <h4>Terminate the Negotiation</h4>

        <button type="button" class="button terminate" id="btn-terminate" style="display: block; margin-bottom: 1cm;" onclick="sendTerminate()">Terminate</button>

            <h5>If you terminate the negotiation:</h5>
            <p style="margin-top:3cm;display: inline;">Your payoff: <div style="display: inline" id="my_payoff_terminate" ></div></p>
            <p style="display: inline;">{{ other_role }}'s payoff: <div style="display: inline" id="other_payoff_terminate" ></div> </p>
    </div>
    <div class="three_columns_right" style="background-color: #ffffff; flex: 0.5">

    </div>

</div>

{% if treatment_communication %}
    <h5 style="margin-top: 1cm;">Please use this chat room to communicate with the {{ other_role }}:</h5>

    <div class="chat">
    {{ chat nickname=my_role}}
    </div>

{% endif %}

</div>

<script src="{{ static 'mgslider.js' }}"></script>

<script
src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
</script>


<script>

    $(document).ready(function (event) {
                    my_slider = new mgslider("offer", 0, 10, 0.1);
                    my_slider.f2s = function (val) {
                        return '$' + val.toFixed(2);
                    }

                    my_slider.print(document.getElementById("my_slider"));
                    //my_slider.recall(); // Optional line to remember value across errors

                    slider_other = new mgslider("other_offer", 0, 10, 0.1);
                    slider_other.f2s = function (val) {
                        return '$' + val.toFixed(2);
                    }

                    slider_other.print(document.getElementById("slider_other"));
                    slider_other.set(0);
                    slider_other.disable();
                    //slider_other.recall(); // Optional line to remember value across errors

                });
   
    let btnOffer = document.getElementById('btn-offer');
    let btnSliderSubmit = document.getElementById('btn-offer-slider');
    
    let msgOtherProposal = document.getElementById('other-proposal');
    let msgMyProposal = document.getElementById('my-proposal');
    
    let btnAccept = document.getElementById('btn-accept');
    let msgMyPayoffAccept = document.getElementById('my_payoff_accept')

    let otherProposal;

    let isFirstClick = true;

    let AlreadyRefreshed = false;


    // Reveal payoff if other player accepts my offer once the slider is clicked for the first time
    var SliderClicked = false

    my_slider.onclick = function() {
        if(!SliderClicked) {
            SliderClicked = true;
        }
    }
    


    function sendOffer() {
        liveSend({'type': 'propose', 'amount': my_slider.value(), 'offer_time': Math.floor(Date.now()/1000 - js_vars.start_time),'latest_proposal_by': js_vars.my_id})
    }

    function sendAccept() {
        liveSend({'type': 'accept', 'amount': otherProposal, 'acceptance_time': Math.floor(Date.now()/1000 - js_vars.start_time), 'accepted_by': js_vars.my_id})
    }

    function sendTerminate() {
        liveSend({'type': 'terminate', 'termination_time': Math.floor(Date.now()/1000 - js_vars.start_time), 'terminated_by': js_vars.my_id})
    }

    let USDollar = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    });


    xValues = [];
    yValues_cost_complete = [];
    yValues_delay_complete = [];

    current_costs = js_vars.initial_TA_costs;
    total_costs = current_costs;

    additional_delay = js_vars.additional_delay
    total_delay = 0;
    

    for (let i = 0; i <= 300; i++) {
        xValues.push(i);

        if (i > 0) {
            current_costs = current_costs - js_vars.decrease_TA_costs_per_second
            if (current_costs < 0) {
                current_costs = 0;
            }
            total_costs += current_costs;
            total_delay += additional_delay;
        }
        yValues_cost_complete.push(total_costs/100);
        yValues_delay_complete.push(total_delay)
        
    }


    function createChart(chartName, yValues, yLabel, yMin, yMax) {
        new Chart(chartName, {
        type: "line",
        data: {
            labels: xValues,
            datasets: [{
                fill: false,
                lineTension: 0,
                backgroundColor: "rgba(0,0,255,1.0)",
                borderColor: "black",
                borderWidth: 1.5,
                data: yValues, 
                step: true,
                fill: false,
                pointRadius: 0,
            }],
        },
        options: {
            //responsive: true, 
            animation: { duration: 0 },
            legend: { display: false },
            scales: {
                yAxes: [{
                    ticks: {
                        min: yMin, 
                        max: yMax
                    },
                    scaleLabel: {
                        display: true, 
                        labelString: yLabel,
                    },
                }],
                xAxes: [{
                    type: 'category',
                    ticks: {
                        //beginAtZero: true,
                        //stepSize: 20,
                        min: 0, 
                        max: xValues.length,
                    },
                    scaleLabel: {
                        display: true, 
                        labelString: "Seconds passed",
                    },
                }]
            },
            maintainAspectRatio: true,
            aspectRatio: 1,
        }
        });
    }
    

    function liveRecv(data) {


        if ('bargaining_time_elapsed' in data) {
            document.getElementById('time_spent').innerHTML = data.bargaining_time_elapsed;

            const yValues_cost = yValues_cost_complete.slice(0, parseInt(data.bargaining_time_elapsed) + 1);
            const yValues_delay = yValues_delay_complete.slice(0, parseInt(data.bargaining_time_elapsed + 1));

            createChart("TA_cost_chart", yValues_cost, "Total Costs ($)", 0, ( Math.ceil( yValues_cost_complete[yValues_cost_complete.length - 1] / 10 )) * 10 );
            createChart("delay_chart", yValues_delay, "Total Delay (Days)", 0, ( Math.ceil( yValues_delay_complete[yValues_delay_complete.length - 1] / 10 )) * 10);
        }

        if ('current_TA_costs' in data) {
            document.getElementById('TA_costs').innerHTML = USDollar.format(data.current_TA_costs/100)
        }

        if ('cumulated_TA_costs' in data) {
            document.getElementById('cumulated_TA_costs').innerHTML = USDollar.format(data.cumulated_TA_costs/100);

            document.getElementById('my_payoff_terminate').innerHTML = USDollar.format(data.current_payoff_terminate/100)

            if (js_vars.information_asymmetry == js_vars.other_role) {
                document.getElementById('other_payoff_terminate').innerHTML = USDollar.format(data.current_payoff_terminate/100)
            } else {
                document.getElementById('other_payoff_terminate').innerHTML = USDollar.format(data.current_payoff_terminate/100)
            }
            

            document.getElementById('payment_delay').innerHTML = data.payment_delay
            
        }

        if ('current_proposals' in data) {

            for (let [id_in_group, proposal] of data.current_proposals) {

                if (id_in_group === js_vars.my_id) {
                    msgMyProposal.innerHTML = USDollar.format(proposal/100);

                    if (!AlreadyRefreshed) {
                        my_slider.set(proposal/100);
                        AlreadyRefreshed = true;
                        SliderClicked = true;
                    }
            
                } else if (id_in_group === js_vars.other_id) {
                    msgOtherProposal.innerHTML = USDollar.format(proposal/100);
                    otherProposal = proposal;
                    btnAccept.disabled = false;
                    slider_other.set(proposal/100);
                    document.getElementById(slider_other.id("cur")).innerHTML = slider_other.f2s(proposal/100, false);

                    if (js_vars.my_role === "Buyer") {
                        msgMyPayoffAccept.innerHTML = USDollar.format((js_vars.my_valuation - proposal - data.cumulated_TA_costs)/100);
                        
                        if (js_vars.information_asymmetry === js_vars.other_role) {
                            document.getElementById('other_payoff_accept').innerHTML = USDollar.format((proposal - js_vars.other_valuation - data.cumulated_TA_costs)/100);
                        }

                    } else if (js_vars.my_role === "Seller") {
                        msgMyPayoffAccept.innerHTML = USDollar.format((proposal - js_vars.my_valuation - data.cumulated_TA_costs)/100);
                        
                        if (js_vars.information_asymmetry === js_vars.other_role) {
                            document.getElementById('other_payoff_accept').innerHTML = USDollar.format((js_vars.other_valuation - proposal - data.cumulated_TA_costs)/100);
                        }
                    }

                }
                
            }
        
            
            
            if (data['latest_proposal_by'] === js_vars.my_id) {
                //btnSliderSubmit.disabled = true;
                //my_slider.submit();
                //my_slider.disable();
                slider_other.disable();

                for (let [id_in_group, proposal] of data.current_proposals) {
                    if(id_in_group === js_vars.my_id) {
                        //my_slider.set(proposal/100);
                        //document.getElementById(my_slider.id("cur")).innerHTML = my_slider.f2s(proposal/100, false);
                    }
                }
                
            } else if (data['latest_proposal_by'] === js_vars.other_id) {
                btnSliderSubmit.disabled = false;
                //my_slider.enable();
                slider_other.disable();
                

            }
        
        }

        if (SliderClicked) {
            //console.log('Slider is clicked for', js_vars.my_id)
            if (js_vars.my_role === "Buyer") {
                document.getElementById('my_payoff_other_accepts_live').innerHTML = USDollar.format((js_vars.my_valuation - my_slider.value()*100 - data.cumulated_TA_costs)/100);
                
                if (js_vars.information_asymmetry === js_vars.other_role) {
                    document.getElementById('other_payoff_other_accepts_live').innerHTML = USDollar.format((my_slider.value()*100 - js_vars.other_valuation - data.cumulated_TA_costs)/100);
                }    

            } else if (js_vars.my_role === "Seller") {
                document.getElementById('my_payoff_other_accepts_live').innerHTML = USDollar.format((my_slider.value()*100 - js_vars.my_valuation - data.cumulated_TA_costs)/100);
                
                if (js_vars.information_asymmetry === js_vars.other_role) {
                    document.getElementById('other_payoff_other_accepts_live').innerHTML = USDollar.format((js_vars.other_valuation - my_slider.value()*100 - data.cumulated_TA_costs)/100);
                }
            }
         
        }
        

        if ('finished' in data) {
            document.getElementById('form').submit();
        }

    }

    // Update live page every second
    setInterval(
        function () {
            liveSend({})
        },
        1000
    )

    document.addEventListener('DOMContentLoaded', (event) => {
        liveSend({});
    });

    
   

</script>

{{ endblock }}