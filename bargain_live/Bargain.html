{{ block title }}
Price Negotiation
{{ endblock }}
{{ block content }} 
<style>
    .mgslider-wrapper {
        border-spacing: 10px;
    }

    .mgslider-limit {
        width: 10%;
        min-width: 75px;
        height: 40px;
        margin: 100px;
        text-align: center;
        background: #eee;
        border: 1px solid #888;
    }

    .mgslider-limit, .mgslider-value {
        font-variant-numeric: tabular-nums;
    }

    .mgslider-before {
        height: 16px;
        width: 100%;
        background: #1e5bff;
    }

    .mgslider-feedback {
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .slider-container {
        display: block;
        align-items: center;
        margin-bottom: 1cm;
    }

    .mgslider-wrapper {
        width: 100%;
        height: 50%; /* Adjust height as needed */
    }

    #submit {
        position: absolute; /* Position button absolutely */
        top: 16.6%; /* Adjust bottom spacing as needed */
        left: 75%; /* Position horizontally centered */
        transform: translateX(-50%); /* Center horizontally */
    }

    .otree-timer {
    display: none;
    }


    .two_columns_left {
        flex: 1;  
        margin-right: 0.25cm;
        padding: 15px;
    }

    .two_columns_right {
        flex: 1;  
        margin-left: 0.25cm;
        padding: 15px;
    }
    body {
    left: 0%;
    transform: translateX(-13%);
    display: flex;
    justify-content: center;
    overflow: auto;
    align-items: center;
    flex-direction: column;
    width: 100%;
    }

    .central_container {
        
        justify-content: center;
        width: 150%;
        position: relative;
    }

    .three_columns_container {
    display: flex;
    justify-content: space-between;
    width: 100%;
    gap: 15px;
    
    }


    .two_columns_container {
        display: flex; 
        justify-content: space-between; 
        margin-top:15px; 
        width: 100%;
    }

    .three_columns_left, .three_columns_right {
        background-color: #dfedf5;
        padding: 15px;
        width: 100%;
    }

    
    
    .chat {
        width: 150%;
    }

</style>


<div class="central_container">

<p>
    You are the {{ player.role }}.
    Please negotiate with the {{ other_role }} below.
</p>

<div class="three_columns_container">
<p style="background-color: #f2f2f2; padding: 15px; width: 150%;">  
   
    In this match, your value of the object is <b>{{ valuation }}</b><br/><br/>
    The {{ other_role }}'s value of the object is 
    {% if information_asymmetry == "None" or information_asymmetry != other_role %}
        <b>unknown to you</b>.
    {% else %}
        <b>{{ other_valuation }}</b>.
    {% endif %}
</p>

</div>
    

<div class="three_columns_container">
    <div class="three_columns_left" style="flex: 0.5;">
        <h5>Negotiation Costs</h5>
        
            <p style="display:inline">Current negotiation costs per second: <div style="display: inline" id ="TA_costs"></div>.</p>
        
            <p style="display:inline"> Total negotiation costs: <div style="display: inline" id ="cumulated_TA_costs"></div>.</p>
        
            <canvas id="TA_cost_chart" style="width: 100%; min-height: 200px;"></canvas>
    </div>

    <div class="three_columns_middle" style="flex: 1;">
    
    <div style="background-color: #f2f2f2; padding: 15px">
        <b><p style="display: inline;"> Time: <div style="display: inline;" id="time_spent"></div> seconds </p></b>

        <h4 style="display:inline">Your current submitted price offer:</h4>
                <div id="my-proposal" style="display: inline; margin-left: 0.5cm;"> No offer yet.</div>
            
            <div class="slider-container">
                <div class="mgslider-wrapper" id="my_slider" style="margin-top: 1cm; margin-bottom: 27px;"></div>
                <button type="button" class="btn btn-success btn-lg active" id="btn-offer-slider" data-bs-toggle="button">Submit</button>
            </div>
        
        <h5>If the {{ other_role }} accepts your current offer: </h5>

            <p style="margin-top:0.25cm;display: inline;">Your payoff: <div style="display: inline" id="my_payoff_other_accepts_live"> No offer yet. </div></p>
            <p style="margin-top:0.25cm;display: inline;">{{ other_role }}'s payoff: 

                    <div style="display: inline" id="other_payoff_other_accepts_live"> 
                        No offer yet. 
                    </div>
                
            </p>

            
    </div>

    <div style="background-color: #f2f2f2; padding: 15px; margin-top: 15px;">
            
        <h4 style="display:inline" style="margin-top: 0.25cm;">{{ other_role }}'s current submitted price offer:</h4>
                <div style="display:inline; margin-left: 0.5cm; margin-top: 0.5cm;" id="other-proposal"> No offer yet. </div>

                <div class="slider-container">
                    <div class="mgslider-wrapper" id="slider_other" style="margin-top: 2cm;"></div>
                
                    <button type="button" class="btn btn-primary btn-lg" id="btn-accept" style="display: block; margin-bottom: 1cm;" disabled>Accept {{other_role}}'s offer</button>
                </div>

                <h5>If you accept the {{ other_role }}'s offer: </h5>

                    <p id="my_payoff_accept_text" style="display: inline; ">Your payoff: <div style="display: inline" id ="my_payoff_accept">No offer yet.</div></p>
                    <p style="display: inline;">{{ other_role }}'s payoff: 
                        {% if my_role == "Seller" %}
            
                                ???
            
                        {% else %}
                            <div style="display: inline" id="other_payoff_accept"> 
                                No offer yet. 
                            </div>
                        
                        {% endif %}
                    </p>

    </div>
    </div>

    <div class="three_columns_right" style="flex: 0.5;">
        <h5>Delay in Payment</h5>

            <p style="display:block">Delay in payment per second: {{ additional_delay }} 
                
                {% if additional_delay == 1 %}
                day.</p>

                {% else %}
                days.</p>

                {% endif %}

            <p style="display:inline">Total delay in payment: <div style="display: inline" id ="payment_delay"></div> day(s).</p>

            <canvas id="delay_chart" style="width: 100%; min-height: 200px;" ></canvas>
    </div>
</div>

<div class="three_columns_container" style="padding: 15px; ">
    <div class="three_columns_left" style="background-color: #ffffff; flex: 0.5">

    </div>
    <div class="three_columns_middle" style="padding: 15px; background-color: #f2f2f2; flex: 1; margin-top: 0cm;">

        <h4>Terminate the Negotiation</h4>

        <button type="button" class="btn btn-danger btn-lg" id="btn-terminate" style="display: block; margin-bottom: 0.25cm;">Terminate</button>

            <h5>If you terminate the negotiation:</h5>
            <p style="margin-top:3cm;display: inline;">Your payoff: <div style="display: inline" id="my_payoff_terminate" ></div></p>
            <p style="display: inline;">{{ other_role }}'s payoff: <div style="display: inline" id="other_payoff_terminate" >???</div> </p>
    </div>
    <div class="three_columns_right" style="background-color: #ffffff; flex: 0.5">

    </div>

</div>

{% if treatment_communication %}
    <h5 style="margin-top: 1cm;">Please use this chat room to communicate with the {{ other_role }}:</h5>

    <div class="chat">
    {{ chat nickname=my_role}}
    </div>

{% endif %}

</div>

<script src="{{ static 'mgslider.js' }}"></script>

<script
src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
</script>

<script src="{{static 'bargaining_functions.js' }}"></script>


<script>


// Initialize global elements after HTML is loaded

document.addEventListener('DOMContentLoaded', function() {
    initializeElements();  
    initializeSliders();
    liveSend({});
});


// Reveal payoff if other player accepts my offer once the slider is clicked for the first time
my_slider.onclick = function() {
    if(!SliderClicked) {
        SliderClicked = true;
    }
}

// Send offer information to server if submit button is clicked
document.getElementById('btn-offer-slider').addEventListener('click', function() {
    sendOffer({
        buttonId: 'btn-offer-slider',
        slider: my_slider,
        startTime: js_vars.start_time,
        myId: js_vars.my_id
    });
});

// Send offer information to server if submit button is clicked
document.getElementById('btn-accept').addEventListener('click', function() {
    sendAccept({
        otherProposal: otherProposal,
        startTime: js_vars.start_time,
        myId: js_vars.my_id
    });
});


// Send terminate information to server if terminate button is clicked
document.getElementById('btn-terminate').addEventListener('click', function() {
    sendTerminate({
        startTime: js_vars.start_time,
        myId: js_vars.my_id
    });
});


function liveRecv(data) {

    updateElementText(
        elementId='time_spent',
        text=data.bargaining_time_elapsed
    );

    updateElementText(
        elementId="payment_delay",
        text=data.payment_delay
    );

    updateCurrencyElement(
        elementId='TA_costs',
        value=data.current_TA_costs
    );

    updateCurrencyElement(
        elementId="cumulated_TA_costs",
        value=data.cumulated_TA_costs
    );

    updateCurrencyElement(
        elementId="my_payoff_terminate",
        value=data.current_payoff_terminate
    );

    updateCharts(
        data=data,
        js_vars=js_vars
    );



    if (data.my_current_proposed_amount){
           
        updateCurrencyElement(
            elementId='my-proposal',
            value=data.my_current_proposed_amount);

        updateCurrencyElement(
            elementId ="other_payoff_other_accepts_live", 
            value=(data.my_current_proposed_amount - js_vars.other_valuation - data.current_TA_costs)/100
        );


        updateCurrencyElement(
            elementId="my_payoff_other_accepts_live",
            value=(js_vars.my_valuation - data.my_current_proposed_amount - data.current_TA_costs)/100
        );

    };

    if (data.other_current_proposed_amount){

        updateCurrencyElement(
        elementId='other-proposal',
        value=data.other_current_proposed_amount);

        // btnAccept.disabled = false;

        // slider_other.set(data.other_current_proposed_amount/100);


        // updateCurrencyElement(
        //     elementId='other_payoff_accept',
        //     value=(data.other_current_proposed_amount - data.cumulated_TA_costs - data.other_valuation)/100
        // );
        // //TO DO: This is not quite correct I need to get the cumulated TA costs of the opponent!

        // updateCurrencyElement(
        //     elemendId="my_payoff_accept",
        //     value=(js_vars.my_valuation - data.other_current_proposed_amount - data.cumulated_TA_costs)/100
        // );
            
    };


        
    



    // if ('current_proposals' in data) {

    //     for (let [id_in_group, proposal] of data.current_proposals) {

    //         if (id_in_group === js_vars.my_id) {
    //             msgMyProposal.innerHTML = USDollar.format(proposal/100);

    //             // if (!AlreadyRefreshed) {
    //             //     my_slider.set(proposal/100);
    //             //     AlreadyRefreshed = true;
    //             //     SliderClicked = true;
    //             // }
        
    //         } else if (id_in_group === js_vars.other_id) {
    //             msgOtherProposal.innerHTML = USDollar.format(proposal/100);
    //             otherProposal = proposal;
    //             btnAccept.disabled = false;
    //             slider_other.set(proposal/100);
    //             document.getElementById(slider_other.id("cur")).innerHTML = slider_other.f2s(proposal/100, false);

    //             if (js_vars.my_role === "Buyer") {
    //                 msgMyPayoffAccept.innerHTML = USDollar.format((js_vars.my_valuation - proposal - data.cumulated_TA_costs)/100);
                    
    //                 // if (js_vars.information_asymmetry === js_vars.other_role) {
    //                 //     document.getElementById('other_payoff_accept').innerHTML = USDollar.format((proposal - js_vars.other_valuation - data.cumulated_TA_costs)/100);
    //                 // }

    //             } else if (js_vars.my_role === "Seller") {
    //                 msgMyPayoffAccept.innerHTML = USDollar.format((proposal - js_vars.my_valuation - data.cumulated_TA_costs)/100);
                    
    //                 if (js_vars.information_asymmetry === js_vars.other_role) {
    //                     document.getElementById('other_payoff_accept').innerHTML = USDollar.format((js_vars.other_valuation - proposal - data.cumulated_TA_costs)/100);
    //                 }
    //             }

    //         }
            
    //     }

    
        
        
    //     if (data['latest_proposal_by'] === js_vars.my_id) {
    //         //btnSliderSubmit.disabled = true;
    //         //my_slider.submit();
    //         //my_slider.disable();
    //         slider_other.disable();

    //         for (let [id_in_group, proposal] of data.current_proposals) {
    //             if(id_in_group === js_vars.my_id) {
    //                 //my_slider.set(proposal/100);
    //                 //document.getElementById(my_slider.id("cur")).innerHTML = my_slider.f2s(proposal/100, false);
    //             }
    //         }
            
    //     } else if (data['latest_proposal_by'] === js_vars.other_id) {
    //         btnSliderSubmit.disabled = false;
    //         //my_slider.enable();
    //         slider_other.disable();
            

    //     }
    
    // }

    // if (SliderClicked) {
    //     //console.log('Slider is clicked for', js_vars.my_id)
    //     if (js_vars.my_role === "Buyer") {
    //         document.getElementById('my_payoff_other_accepts_live').innerHTML = USDollar.format((js_vars.my_valuation - my_slider.value()*100 - data.cumulated_TA_costs)/100);
            
    //         if (js_vars.information_asymmetry === js_vars.other_role) {
    //             document.getElementById('other_payoff_other_accepts_live').innerHTML = USDollar.format((my_slider.value()*100 - js_vars.other_valuation - data.cumulated_TA_costs)/100);
    //         }    

    //     } else if (js_vars.my_role === "Seller") {
    //         document.getElementById('my_payoff_other_accepts_live').innerHTML = USDollar.format((my_slider.value()*100 - js_vars.my_valuation - data.cumulated_TA_costs)/100);
            
    //         if (js_vars.information_asymmetry === js_vars.other_role) {
    //             document.getElementById('other_payoff_other_accepts_live').innerHTML = USDollar.format((js_vars.other_valuation - my_slider.value()*100 - data.cumulated_TA_costs)/100);
    //         }
    //     }
        
    // }
    

    if ('finished' in data) {
        document.getElementById('form').submit()
    };

}


// Update live page every second
setInterval(
    function () {
        liveSend({})
    },
    1000
)

</script>

{{ endblock }}